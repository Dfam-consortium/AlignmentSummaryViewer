/*! AlignmentSummaryViewer 10-12-2021 */

!function(t){"use strict";function i(e,t,i,n){this.json=i,this.align_canvas=e,this.parent_element=t,this.cursorImage=null,this.cursorImageStartX=0,this.cursorImageStartY=0,this.cursorImageWidth=0,this.cursorImageHeight=0,this.fontSize=10,this.minLeftMargin=55,this.minTopMargin=10,this.minBottomMargin=10,this.coverageGraphHeight=125,this.legendHeight=30,this.alignmentGlyphHeight=2,this.alignmentSpacing=0,this.rulerHeight=20,this.yAxisFontSize=10,this.rulerVerticalMargin=10,this.gradientWindowFrac=.1,this.coverageGraphStartY=this.minTopMargin,this.rulerStartY=this.coverageGraphStartY+this.coverageGraphHeight,this.alignmentGraphStartY=this.rulerStartY+this.rulerHeight,this.legendStartY=this.alignmentGraphStartY+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing);var a=this;this.align_canvas.addEventListener("mousemove",function(t){var i=e.getBoundingClientRect(),i={x:t.clientX-i.left,y:t.clientY-i.top};a.renderCrosshair(i.x,i.y)}),this.align_canvas.addEventListener("mouseout",function(t){null!==a.cursorImage&&a.align_context.putImageData(a.cursorImage,a.cursorImageStartX,a.cursorImageStartY)}),this.align_context=this.align_canvas.getContext("2d"),this.qualColor=["#ff6600","#ff9900","#ccff00","#66ff00","#00ff00","#99ff66","#00ffcc","#33ccff","#3399ff","#3333ff"],this.currRulerY=0,this.resize()}i.prototype.setData=function(t){this.json=t,this.align_context.clearRect(0,0,this.align_canvas.width,this.align_canvas.height),this.legendStartY=this.alignmentGraphStartY+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing),this.cursorImage=null,this.resize()},i.prototype.renderCrosshair=function(t,i){var e,n=this.align_context,a=this.json.length/(this.align_canvas.width-this.minLeftMargin),r=Math.floor(a*(t-this.minLeftMargin))+1,a=(e=this.align_context.measureText(""+this.json.length).width)+6;null!==this.cursorImage&&(n.putImageData(this.cursorImage,this.cursorImageStartX,this.cursorImageStartY),this.cursorImage=null),i>=this.alignmentGraphStartY&&i<this.legendStartY&&t>this.minLeftMargin&&(this.cursorImageStartX=t-2*a,this.cursorImageStartY=this.rulerStartY,this.cursorImageWidth=a+2*a,this.cursorImageHeight=this.legendStartY-this.rulerStartY,this.cursorImage=n.getImageData(this.cursorImageStartX,this.cursorImageStartY,this.cursorImageWidth,this.cursorImageHeight),n.lineWidth=1,n.beginPath(),n.moveTo(t,this.rulerStartY),n.lineTo(t,this.legendStartY-1),n.stroke(),i-a<this.rulerStartY&&(i=this.rulerStartY+a+2),(t=t)+a/2>this.align_canvas.width&&(t=this.align_canvas.width-a/2),n.beginPath(),n.arc(t,i-a/2,a/2,0,2*Math.PI,!1),n.fillStyle="#ffffff",n.fill(),n.strokeStyle="#000000",n.stroke(),this.align_context.fillStyle="#000000",e=this.align_context.measureText(""+r).width,n.fillText(""+r,t-e/2,i-a/2+this.fontSize/2-1))},i.prototype.resize=function(){this.align_canvas.width=this.parent_element.offsetWidth,this.align_canvas.height=this.minTopMargin+this.coverageGraphHeight+this.rulerHeight+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing)+this.legendHeight+this.minBottomMargin,this.render("norm")},i.prototype.ruler=function(t,i,e,n,a,r,s,h){this.align_context.beginPath(),this.align_context.moveTo(t,i),this.align_context.lineTo(t+e,i),this.align_context.stroke();if(this.align_context.font="normal 10px Arial",!(n<20)){var a=e/(r-a+1),o=h*a,l=s*a,g=n-10-2,c=g/2;this.align_context.fillStyle="#000000";var m=0;if(0<o)for(var f=0,m=o;m<e;m+=o){f+=1,this.align_context.beginPath(),this.align_context.moveTo(t+m,i),this.align_context.lineTo(t+m,i+g),this.align_context.stroke();var u=this.align_context.measureText(""+f*h).width;this.align_context.fillText(""+f*h,t+m-u/2,i+g+10)}if(0<l)for(m=l;m<e;m+=l)this.align_context.beginPath(),this.align_context.moveTo(t+m,i),this.align_context.lineTo(t+m,i+c),this.align_context.stroke()}},i.prototype.coverageGraph=function(t,i){var e=this.json.alignments,n=[],a=this.json.length/(this.align_canvas.width-this.minLeftMargin),r=(this.align_canvas.width-this.minLeftMargin)/this.json.length,s=this.align_context,h=t+this.yAxisFontSize/2,o=i-(h-t);if(s.beginPath(),s.moveTo(this.minLeftMargin-1,h),s.lineTo(this.minLeftMargin-1,t+i),s.stroke(),s.save(),s.translate(10,i/2),s.rotate(-Math.PI/2),s.textAlign="center",s.font="normal 10px Arial",s.fillText("Number of Matches",1,0),s.restore(),!(i<=h)){var l=0,g=0,c=0;for(g=0;g<e.length;g+=1)for(var m=e[g][1]-1,f=e[g][2],c=m;c<=m+f;c+=1)void 0!==n[c]?n[c]=n[c]+1:n[c]=1,n[c]>l&&(l=n[c]);var u=this.align_context.measureText(""+(l=l<10?10:l)).width;s.fillText(""+l,this.minLeftMargin-u-8,t+this.yAxisFontSize),s.beginPath(),s.moveTo(this.minLeftMargin,h),s.lineTo(this.minLeftMargin-5,h),s.stroke();for(var x=0,p=this.nice_bounds(0,l,5),x=p.steps;x<p.max;x+=p.steps){var v=t+i-this.scale(x,l,o);if(v<=10)break;var _=this.minLeftMargin;s.beginPath(),s.moveTo(_,v),s.lineTo(_-5,v),s.stroke();var d=""+x,u=s.measureText(d).width;s.fillText(d,_-u-8,v)}var S=o/l;this.align_context.fillStyle="#739025",this.align_context.strokeStyle="#000000";var T=this.minLeftMargin;if(1<=a){var M=this.align_canvas.width-this.minLeftMargin;this.align_context.beginPath(),this.align_context.moveTo(T,t+i-1);for(var y=0,g=0;g<M;g+=1){var Y=0;for(c=0;c<Math.floor(a);c+=1)Y+=n[Math.floor(y)+c];Y+=n[Math.floor(y)+c+1]*(a%1),y+=a,this.align_context.lineTo(T,t+i-Y/a*S-1),T+=1}this.align_context.lineTo(T,t+i-1),this.align_context.lineTo(0,t+i-1),this.align_context.fill(),this.align_context.closePath()}else{for(this.align_context.beginPath(),this.align_context.moveTo(T,t+i-1),g=0;g<this.json.length;g+=1){var L=n[g];this.align_context.lineTo(T,t+i-L*S-1),T+=r}this.align_context.lineTo(T,t+i-L*S-1),this.align_context.lineTo(T,t+i-1),this.align_context.lineTo(0,t+i-1),this.align_context.fill(),this.align_context.closePath()}}},i.prototype.nice_bounds=function(t,i,e){e=e||10;var n=i,a=i-t;0===a&&(a=(i+=.5)-(t-=.5));a=this.nice_number(a),e=this.nice_number(a/(e-1),!0);return{min:t=Math.floor(t/e)*e,max:i=n-(i=Math.ceil(i/e)*e)<e/4?Math.floor(n/e)*e:i,steps:e}},i.prototype.nice_number=function(t,i){i=i||!1;var e=Math.floor(Math.log(t)/Math.log(10)),t=t/Math.pow(10,e),t=i?t<1.5?1:t<3?2:t<7?5:10:t<=1?1:t<=2?2:t<=5?5:10;return t*Math.pow(10,e)},i.prototype.scale=function(t,i,e){return e*t/i},i.prototype.render=function(t){var i=this.alignmentGlyphHeight,e=this.alignmentSpacing,n=this.rulerHeight,a=this.rulerVerticalMargin,r=this.coverageGraphHeight,s=this.gradientWindowFrac,h=this.align_canvas.width-this.minLeftMargin,o=h/this.json.length,l=this.json.alignments,g=this.json.qualityBlockLen,c=g*o,m=l.length*(this.alignmentGlyphHeight+this.alignmentSpacing);this.cursorImage=null,this.align_context.clearRect(0,0,this.align_canvas.width,this.align_canvas.height);var f=this.align_context;f.beginPath(),f.moveTo(this.minLeftMargin-1,this.rulerStartY),f.lineTo(this.minLeftMargin-1,this.rulerStartY+this.rulerHeight+m),f.stroke(),f.save(),f.translate(10,this.alignmentGraphStartY+m/2),f.rotate(-Math.PI/2),f.textAlign="center",f.font="normal 10px Arial",f.fillText("Sequence",1,0),f.restore();var u=this.align_context.measureText("1").width;f.fillText("1",this.minLeftMargin-u-8,this.alignmentGraphStartY),f.beginPath(),f.moveTo(this.minLeftMargin,this.alignmentGraphStartY+1),f.lineTo(this.minLeftMargin-5,this.alignmentGraphStartY+1),f.stroke(),u=this.align_context.measureText(""+l.length).width,f.fillText(""+l.length,this.minLeftMargin-u-8,this.alignmentGraphStartY+m+this.yAxisFontSize),f.beginPath(),f.moveTo(this.minLeftMargin,this.alignmentGraphStartY+m),f.lineTo(this.minLeftMargin-5,this.alignmentGraphStartY+m),f.stroke();for(var x=this.legendStartY+15,m=this.minLeftMargin+20,p=this.align_context.createLinearGradient(m,0,m+100,0),v=1/this.qualColor.length,_=0,_=0;_<this.qualColor.length;_+=1)p.addColorStop(v*_,this.qualColor[_]);f.fillStyle=p,f.fillRect(m,x,100,5),f.fillStyle="#000000",f.fillText("Alignment quality over "+g+"bp non-overlapping windows",m+100+10,x+this.yAxisFontSize),f.fillText("low",m,x+5+this.yAxisFontSize),u=this.align_context.measureText("high").width,f.fillText("high",m+100-u,x+5+this.yAxisFontSize),"orient"==t?l.sort(function(t,i){return t[4]===i[4]?"R"===t[4]?t[1]===i[1]?i[2]-t[2]:t[1]-i[1]:t[1]===i[1]?t[2]-i[2]:i[1]-t[1]:t[4]<i[4]?-1:t[4]>i[4]?1:0}):"end"==t?l.sort(function(t,i){return t[1]+t[2]==i[1]+i[2]?t[1]-i[1]:i[1]+i[2]-(t[1]+t[2])}):"div"==t?l.sort(function(t,i){return t[5]-i[5]}):l.sort(function(t,i){return t[1]===i[1]?i[2]-t[2]:t[1]-i[1]}),this.coverageGraph(this.coverageGraphStartY,this.coverageGraphHeight);var d=0,S=0;for("orient"!=t&&(t=this.nice_bounds(1,this.json.length,10).steps,this.ruler(this.minLeftMargin,this.rulerStartY,h,n,1,this.json.length,t/10,t),this.currRulerY=0,d=a+n+r,S=1),_=0;_<l.length;_+=1){0===S&&"R"==l[_][4]&&(d+=a,this.currRulerY=d+_*(e+i),d=d+n+a+r,S=1);for(var T=l[_][1]-1,M=l[_][3],y=0,Y=0;Y<l[_][2];Y+=g){y==M.length&&(y-=1);var L=M[y],I=y==M.length-1?L:M[y+1],w=this.minLeftMargin+(T+Y)*o,G=this.align_context.createLinearGradient(w,0,w+c,0);G.addColorStop(0,this.qualColor[L-1]),G.addColorStop(1-s,this.qualColor[L-1]),G.addColorStop(1,this.qualColor[I-1]),this.align_context.fillStyle=G;G=(g+.5)*o;Y+g>=l[_][2]&&(G=(l[_][2]-Y)*o),this.align_context.fillRect(w,d+_*(e+i),G,i),this.minLeftMargin,y++}}},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=i:(t.AlignmentSummaryViewer=i,"function"==typeof define&&define.amd&&define("alignmentsummaryviewer",[],function(){return i}))}(this.window||"undefined"!=typeof global&&global||this);