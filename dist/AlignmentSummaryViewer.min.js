/*! AlignmentSummaryViewer 02-05-2017 */
!function(a){"use strict";function b(a,b,c){this.json=b,this.align_canvas=a,this.cursorImage=null,this.cursorImageStartX=0,this.cursorImageStartY=0,this.cursorImageWidth=0,this.cursorImageHeight=0,this.fontSize=10,this.minLeftMargin=55,this.minTopMargin=10,this.minBottomMargin=10,this.coverageGraphHeight=125,this.legendHeight=30,this.alignmentGlyphHeight=1,this.alignmentSpacing=1,this.rulerHeight=20,this.yAxisFontSize=10,this.rulerVerticalMargin=10,this.gradientWindowFrac=.3,this.coverageGraphStartY=this.minTopMargin,this.rulerStartY=this.coverageGraphStartY+this.coverageGraphHeight,this.alignmentGraphStartY=this.rulerStartY+this.rulerHeight,this.legendStartY=this.alignmentGraphStartY+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing),this.resetHeight();var d=this;this.align_canvas.addEventListener("mousemove",function(b){var c=a.getBoundingClientRect(),e={x:b.clientX-c.left,y:b.clientY-c.top};d.renderCrosshair(e.x,e.y)}),this.align_canvas.addEventListener("mouseout",function(a){null!==d.cursorImage&&d.align_context.putImageData(d.cursorImage,d.cursorImageStartX,d.cursorImageStartY)}),this.align_context=this.align_canvas.getContext("2d"),this.qualColor=["#ff6600","#ffcc00","#ccff00","#66ff00","#00ff00","#00ff66","#00ffcc","#00ccff","#0066ff","#0000ff"],this.WIDTH=this.align_canvas.width,this.HEIGHT=this.align_canvas.height,this.pixelToBP=this.json.length/this.WIDTH,this.currRulerY=0,this.render("norm")}b.prototype.setData=function(a){this.json=a,this.align_context.clearRect(0,0,this.align_canvas.width,this.align_canvas.height),this.legendStartY=this.alignmentGraphStartY+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing),this.cursorImage=null,this.resetHeight(),this.render("norm")},b.prototype.renderCrosshair=function(a,b){var c=this.align_context,d=this.json.length/(this.align_canvas.width-this.minLeftMargin),e=Math.floor(d*(a-this.minLeftMargin))+1,f=this.align_context.measureText(""+this.json.length).width,g=f+6;if(null!==this.cursorImage&&(c.putImageData(this.cursorImage,this.cursorImageStartX,this.cursorImageStartY),this.cursorImage=null),b>=this.alignmentGraphStartY&&b<this.legendStartY&&a>this.minLeftMargin){this.cursorImageStartX=a-2*g,this.cursorImageStartY=this.rulerStartY,this.cursorImageWidth=g+2*g,this.cursorImageHeight=this.legendStartY-this.rulerStartY,this.cursorImage=c.getImageData(this.cursorImageStartX,this.cursorImageStartY,this.cursorImageWidth,this.cursorImageHeight),c.lineWidth=1,c.beginPath(),c.moveTo(a,this.rulerStartY),c.lineTo(a,this.legendStartY-1),c.stroke(),b-g<this.rulerStartY&&(b=this.rulerStartY+g+2);var h=a;a+g/2>this.align_canvas.width&&(h=this.align_canvas.width-g/2),c.beginPath(),c.arc(h,b-g/2,g/2,0,2*Math.PI,!1),c.fillStyle="#ffffff",c.fill(),c.strokeStyle="#000000",c.stroke(),this.align_context.fillStyle="#000000",f=this.align_context.measureText(""+e).width,c.fillText(""+e,h-f/2,b-g/2+this.fontSize/2-1)}},b.prototype.resetHeight=function(){this.align_canvas.width=window.innerWidth-20,this.align_canvas.height=this.minTopMargin+this.coverageGraphHeight+this.rulerHeight+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing)+this.legendHeight+this.minBottomMargin},b.prototype.ruler=function(a,b,c,d,e,f,g,h){this.align_context.beginPath(),this.align_context.moveTo(a,b),this.align_context.lineTo(a+c,b),this.align_context.stroke();var i=10;if(this.align_context.font="normal "+i+"px Arial",!(d<2*i)){var j=c/(f-e+1),k=h*j,l=g*j,m=d-i-2,n=m/2;this.align_context.fillStyle="#000000";var o=0;if(k>0){var p=0;for(o=k;o<c;o+=k){p+=1,this.align_context.beginPath(),this.align_context.moveTo(a+o,b),this.align_context.lineTo(a+o,b+m),this.align_context.stroke();var q=this.align_context.measureText(""+p*h).width;this.align_context.fillText(""+p*h,a+o-q/2,b+m+i)}}if(l>0)for(o=l;o<c;o+=l)this.align_context.beginPath(),this.align_context.moveTo(a+o,b),this.align_context.lineTo(a+o,b+n),this.align_context.stroke()}},b.prototype.coverageGraph=function(a,b){var c=0,d=this.json.alignments,e=[],f=this.json.length/(this.align_canvas.width-this.minLeftMargin),g=(this.align_canvas.width-this.minLeftMargin)/this.json.length,h=this.align_context,i=a+this.yAxisFontSize/2,j=b-(i-a);if(h.beginPath(),h.moveTo(this.minLeftMargin-1,i),h.lineTo(this.minLeftMargin-1,a+b),h.stroke(),h.save(),h.translate(10,b/2),h.rotate(-Math.PI/2),h.textAlign="center",h.font="normal 10px Arial",h.fillText("Number of Matches",1,0),h.restore(),!(b<=i)){var k=0,l=0,m=0;for(l=0;l<d.length;l+=1){var n=d[l][1]-1,o=d[l][2];for(m=n;m<=n+o;m+=1)void 0!==e[m]?(e[m]=e[m]+1,e[m]>k&&(k=e[m])):(e[m]=1,e[m]>k&&(k=e[m]))}var p=this.align_context.measureText(""+k).width;h.fillText(""+k,this.minLeftMargin-p-8,a+this.yAxisFontSize),h.beginPath(),h.moveTo(this.minLeftMargin,i),h.lineTo(this.minLeftMargin-5,i),h.stroke();var q=0,r=this.nice_bounds(0,parseInt(k),5);for(q=r.steps;q<r.max;q+=r.steps){var s=a+b-this.scale(q,k,j);if(s<=10)break;var t=this.minLeftMargin;h.beginPath(),h.moveTo(t,s),h.lineTo(t-5,s),h.stroke(),p=this.align_context.measureText(""+q).width,h.fillText(q,t-p-8,s)}var u=j/k;this.align_context.fillStyle="#739025",this.align_context.strokeStyle="#000000";var v=this.minLeftMargin;if(f>=1){var w=this.align_canvas.width-this.minLeftMargin;this.align_context.beginPath(),this.align_context.moveTo(v,a+b-1);var x=0;for(l=0;l<w;l+=1){var y=0;for(m=0;m<Math.floor(f);m+=1)y+=e[x+m];y+=e[x+m+1]*(f%1);var z=y/f;x+=Math.floor(f),this.align_context.lineTo(v,a+b-z*u-1),v+=1}0===c?(this.align_context.lineTo(v,a+b-1),this.align_context.lineTo(0,a+b-1),this.align_context.fill()):this.align_context.stroke(),this.align_context.closePath()}else{for(this.align_context.beginPath(),this.align_context.moveTo(v,a+b-1),l=0;l<this.json.length;l+=1){var A=e[l];this.align_context.lineTo(v+g,a+b-A*u-1),v+=g}0===c?(this.align_context.lineTo(v,a+b-1),this.align_context.lineTo(0,a+b-1),this.align_context.fill()):this.align_context.stroke(),this.align_context.closePath()}}},b.prototype.nice_bounds=function(a,b,c){c=c||10;var d=b,e=b-a;0===e&&(a-=.5,b+=.5,e=b-a);var f=this.nice_number(e),g=this.nice_number(f/(c-1),!0);return a=Math.floor(a/g)*g,b=Math.ceil(b/g)*g,d-b<g/4&&(b=Math.floor(d/g)*g),{min:a,max:b,steps:g}},b.prototype.nice_number=function(a,b){b=b||!1;var c=Math.floor(Math.log(a)/Math.log(10)),d=a/Math.pow(10,c);return(b?d<1.5?1:d<3?2:d<7?5:10:d<=1?1:d<=2?2:d<=5?5:10)*Math.pow(10,c)},b.prototype.scale=function(a,b,c){return c*a/b},b.prototype.render=function(a){var b=this.alignmentGlyphHeight,c=this.alignmentSpacing,d=this.rulerHeight,e=this.rulerVerticalMargin,f=this.coverageGraphHeight,g=this.gradientWindowFrac,h=this.align_canvas.width-this.minLeftMargin,i=h/this.json.length,j=this.json.alignments,k=this.json.qualityBlockLen,l=k*i,m=l*g*.5,n=j.length*(this.alignmentGlyphHeight+this.alignmentSpacing);this.cursorImage=null;var o=this.align_context;o.beginPath(),o.moveTo(this.minLeftMargin-1,this.rulerStartY),o.lineTo(this.minLeftMargin-1,this.rulerStartY+this.rulerHeight+n),o.stroke(),o.save(),o.translate(10,this.alignmentGraphStartY+n/2),o.rotate(-Math.PI/2),o.textAlign="center",o.font="normal 10px Arial",o.fillText("Sequence",1,0),o.restore();var p=this.align_context.measureText("1").width;o.fillText("1",this.minLeftMargin-p-8,this.alignmentGraphStartY+this.yAxisFontSize/2),o.beginPath(),o.moveTo(this.minLeftMargin,this.alignmentGraphStartY+1),o.lineTo(this.minLeftMargin-5,this.alignmentGraphStartY+1),o.stroke(),p=this.align_context.measureText(""+j.length).width,o.fillText(""+j.length,this.minLeftMargin-p-8,this.alignmentGraphStartY+n),o.beginPath(),o.moveTo(this.minLeftMargin,this.alignmentGraphStartY+n),o.lineTo(this.minLeftMargin-5,this.alignmentGraphStartY+n),o.stroke();var q=this.legendStartY+15,r=this.minLeftMargin+20,s=100,t=5,u=this.align_context.createLinearGradient(r,0,r+s,0),v=1/this.qualColor.length,w=0;for(w=0;w<this.qualColor.length;w+=1)u.addColorStop(v*w,this.qualColor[w]);o.fillStyle=u,o.fillRect(r,q,s,t),o.fillStyle="#000000",o.fillText("Alignment quality over "+k+"bp non-overlapping windows",r+s+10,q+this.yAxisFontSize),o.fillText("low",r,q+t+this.yAxisFontSize),p=this.align_context.measureText("high").width,o.fillText("high",r+s-p,q+t+this.yAxisFontSize),"orient"==a?j.sort(function(a,b){return a[4]===b[4]?"R"===a[4]?a[1]===b[1]?b[2]-a[2]:a[1]-b[1]:a[1]===b[1]?a[2]-b[2]:b[1]-a[1]:a[4]<b[4]?-1:a[4]>b[4]?1:0}):"end"==a?j.sort(function(a,b){return a[1]+a[2]==b[1]+b[2]?a[1]-b[1]:b[1]+b[2]-(a[1]+a[2])}):"div"==a?j.sort(function(a,b){return a[5]-b[5]}):j.sort(function(a,b){return a[1]===b[1]?b[2]-a[2]:a[1]-b[1]}),this.coverageGraph(this.coverageGraphStartY,this.coverageGraphHeight);var x=0,y=0;for("orient"!=a&&(this.ruler(this.minLeftMargin,this.rulerStartY,h,d,1,this.json.length,10,100),this.currRulerY=0,x=e+d+f,y=1),w=0;w<j.length;w+=1){0===y&&"R"==j[w][4]&&(x+=e,this.currRulerY=x+w*(c+b),x=x+d+e+f,y=1);var z,A,B,C=j[w][1]-1,D=j[w][3],E=0,F=D[0];for(B=0;B<j[w][2];B+=k){E==D.length&&(E-=1),z=D[E],A=E==D.length-1?z:D[E+1];var G=this.minLeftMargin+(C+B)*i,H=this.align_context.createLinearGradient(G-m,0,G+l+m,0);H.addColorStop(0,this.qualColor[F-1]),H.addColorStop(g,this.qualColor[z-1]),H.addColorStop(1-g,this.qualColor[z-1]),H.addColorStop(1,this.qualColor[A-1]),F=z,this.align_context.fillStyle=H;var I=l;B+k>j[w][2]&&(I=(j[w][2]-B)*i),this.align_context.fillRect(G,x+w*(c+b),I,b),this.minLeftMargin,E++}}},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=b:(a.AlignmentSummaryViewer=b,"function"==typeof define&&define.amd&&define("alignmentsummaryviewer",[],function(){return b}))}(this.window||"undefined"!=typeof global&&global||this);