/*! AlignmentSummaryViewer 08-01-2019 */

!function(t){"use strict";function i(n,t,i,e){this.json=i,this.align_canvas=n,this.parent_element=t,this.cursorImage=null,this.cursorImageStartX=0,this.cursorImageStartY=0,this.cursorImageWidth=0,this.cursorImageHeight=0,this.fontSize=10,this.minLeftMargin=55,this.minTopMargin=10,this.minBottomMargin=10,this.coverageGraphHeight=125,this.legendHeight=30,this.alignmentGlyphHeight=2,this.alignmentSpacing=0,this.rulerHeight=20,this.yAxisFontSize=10,this.rulerVerticalMargin=10,this.gradientWindowFrac=.1,this.coverageGraphStartY=this.minTopMargin,this.rulerStartY=this.coverageGraphStartY+this.coverageGraphHeight,this.alignmentGraphStartY=this.rulerStartY+this.rulerHeight,this.legendStartY=this.alignmentGraphStartY+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing);var a=this;this.align_canvas.addEventListener("mousemove",function(t){var i=n.getBoundingClientRect(),e={x:t.clientX-i.left,y:t.clientY-i.top};a.renderCrosshair(e.x,e.y)}),this.align_canvas.addEventListener("mouseout",function(t){null!==a.cursorImage&&a.align_context.putImageData(a.cursorImage,a.cursorImageStartX,a.cursorImageStartY)}),this.align_context=this.align_canvas.getContext("2d"),this.qualColor=["#ff6600","#ff9900","#ccff00","#66ff00","#00ff00","#99ff66","#00ffcc","#33ccff","#3399ff","#3333ff"],this.currRulerY=0,this.resize()}i.prototype.setData=function(t){this.json=t,this.align_context.clearRect(0,0,this.align_canvas.width,this.align_canvas.height),this.legendStartY=this.alignmentGraphStartY+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing),this.cursorImage=null,this.resize()},i.prototype.renderCrosshair=function(t,i){var e=this.align_context,n=this.json.length/(this.align_canvas.width-this.minLeftMargin),a=Math.floor(n*(t-this.minLeftMargin))+1,r=this.align_context.measureText(""+this.json.length).width,s=r+6;if(null!==this.cursorImage&&(e.putImageData(this.cursorImage,this.cursorImageStartX,this.cursorImageStartY),this.cursorImage=null),i>=this.alignmentGraphStartY&&i<this.legendStartY&&t>this.minLeftMargin){this.cursorImageStartX=t-2*s,this.cursorImageStartY=this.rulerStartY,this.cursorImageWidth=s+2*s,this.cursorImageHeight=this.legendStartY-this.rulerStartY,this.cursorImage=e.getImageData(this.cursorImageStartX,this.cursorImageStartY,this.cursorImageWidth,this.cursorImageHeight),e.lineWidth=1,e.beginPath(),e.moveTo(t,this.rulerStartY),e.lineTo(t,this.legendStartY-1),e.stroke(),i-s<this.rulerStartY&&(i=this.rulerStartY+s+2);var h=t;t+s/2>this.align_canvas.width&&(h=this.align_canvas.width-s/2),e.beginPath(),e.arc(h,i-s/2,s/2,0,2*Math.PI,!1),e.fillStyle="#ffffff",e.fill(),e.strokeStyle="#000000",e.stroke(),this.align_context.fillStyle="#000000",r=this.align_context.measureText(""+a).width,e.fillText(""+a,h-r/2,i-s/2+this.fontSize/2-1)}},i.prototype.resize=function(){this.align_canvas.width=this.parent_element.offsetWidth,this.align_canvas.height=this.minTopMargin+this.coverageGraphHeight+this.rulerHeight+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing)+this.legendHeight+this.minBottomMargin,this.render("norm")},i.prototype.ruler=function(t,i,e,n,a,r,s,h){this.align_context.beginPath(),this.align_context.moveTo(t,i),this.align_context.lineTo(t+e,i),this.align_context.stroke();if(this.align_context.font="normal 10px Arial",!(n<20)){var o=e/(r-a+1),l=h*o,g=s*o,c=n-10-2,f=c/2;this.align_context.fillStyle="#000000";var m=0;if(0<l){var u=0;for(m=l;m<e;m+=l){u+=1,this.align_context.beginPath(),this.align_context.moveTo(t+m,i),this.align_context.lineTo(t+m,i+c),this.align_context.stroke();var x=this.align_context.measureText(""+u*h).width;this.align_context.fillText(""+u*h,t+m-x/2,i+c+10)}}if(0<g)for(m=g;m<e;m+=g)this.align_context.beginPath(),this.align_context.moveTo(t+m,i),this.align_context.lineTo(t+m,i+f),this.align_context.stroke()}},i.prototype.coverageGraph=function(t,i){var e=this.json.alignments,n=[],a=this.json.length/(this.align_canvas.width-this.minLeftMargin),r=(this.align_canvas.width-this.minLeftMargin)/this.json.length,s=this.align_context,h=t+this.yAxisFontSize/2,o=i-(h-t);if(s.beginPath(),s.moveTo(this.minLeftMargin-1,h),s.lineTo(this.minLeftMargin-1,t+i),s.stroke(),s.save(),s.translate(10,i/2),s.rotate(-Math.PI/2),s.textAlign="center",s.font="normal 10px Arial",s.fillText("Number of Matches",1,0),s.restore(),!(i<=h)){var l=0,g=0,c=0;for(g=0;g<e.length;g+=1){var f=e[g][1]-1,m=e[g][2];for(c=f;c<=f+m;c+=1)void 0!==n[c]?n[c]=n[c]+1:n[c]=1,n[c]>l&&(l=n[c])}var u=this.align_context.measureText(""+l).width;s.fillText(""+l,this.minLeftMargin-u-8,t+this.yAxisFontSize),s.beginPath(),s.moveTo(this.minLeftMargin,h),s.lineTo(this.minLeftMargin-5,h),s.stroke();var x=0,v=this.nice_bounds(0,parseInt(l),5);for(x=v.steps;x<v.max;x+=v.steps){var p=t+i-this.scale(x,l,o);if(p<=10)break;var _=this.minLeftMargin;s.beginPath(),s.moveTo(_,p),s.lineTo(_-5,p),s.stroke(),u=this.align_context.measureText(""+x).width,s.fillText(x,_-u-8,p)}var d=o/l;this.align_context.fillStyle="#739025",this.align_context.strokeStyle="#000000";var S=this.minLeftMargin;if(1<=a){var M=this.align_canvas.width-this.minLeftMargin;this.align_context.beginPath(),this.align_context.moveTo(S,t+i-1);var T=0;for(g=0;g<M;g+=1){var y=0;for(c=0;c<Math.floor(a);c+=1)y+=n[Math.floor(T)+c];var Y=(y+=n[Math.floor(T)+c+1]*(a%1))/a;T+=a,this.align_context.lineTo(S,t+i-Y*d-1),S+=1}this.align_context.lineTo(S,t+i-1),this.align_context.lineTo(0,t+i-1),this.align_context.fill(),this.align_context.closePath()}else{for(this.align_context.beginPath(),this.align_context.moveTo(S,t+i-1),g=0;g<this.json.length;g+=1){var I=n[g];this.align_context.lineTo(S+r,t+i-I*d-1),S+=r}this.align_context.lineTo(S,t+i-1),this.align_context.lineTo(0,t+i-1),this.align_context.fill(),this.align_context.closePath()}}},i.prototype.nice_bounds=function(t,i,e){e=e||10;var n=i,a=i-t;0===a&&(a=(i+=.5)-(t-=.5));var r=this.nice_number(a),s=this.nice_number(r/(e-1),!0);return t=Math.floor(t/s)*s,n-(i=Math.ceil(i/s)*s)<s/4&&(i=Math.floor(n/s)*s),{min:t,max:i,steps:s}},i.prototype.nice_number=function(t,i){i=i||!1;var e=Math.floor(Math.log(t)/Math.log(10)),n=t/Math.pow(10,e);return(i?n<1.5?1:n<3?2:n<7?5:10:n<=1?1:n<=2?2:n<=5?5:10)*Math.pow(10,e)},i.prototype.scale=function(t,i,e){return e*t/i},i.prototype.render=function(t){var i=this.alignmentGlyphHeight,e=this.alignmentSpacing,n=this.rulerHeight,a=this.rulerVerticalMargin,r=this.coverageGraphHeight,s=this.gradientWindowFrac,h=this.align_canvas.width-this.minLeftMargin,o=h/this.json.length,l=this.json.alignments,g=this.json.qualityBlockLen,c=g*o,f=l.length*(this.alignmentGlyphHeight+this.alignmentSpacing);this.cursorImage=null,this.align_context.clearRect(0,0,this.align_canvas.width,this.align_canvas.height);var m=this.align_context;m.beginPath(),m.moveTo(this.minLeftMargin-1,this.rulerStartY),m.lineTo(this.minLeftMargin-1,this.rulerStartY+this.rulerHeight+f),m.stroke(),m.save(),m.translate(10,this.alignmentGraphStartY+f/2),m.rotate(-Math.PI/2),m.textAlign="center",m.font="normal 10px Arial",m.fillText("Sequence",1,0),m.restore();var u=this.align_context.measureText("1").width;m.fillText("1",this.minLeftMargin-u-8,this.alignmentGraphStartY+this.yAxisFontSize/2),m.beginPath(),m.moveTo(this.minLeftMargin,this.alignmentGraphStartY+1),m.lineTo(this.minLeftMargin-5,this.alignmentGraphStartY+1),m.stroke(),u=this.align_context.measureText(""+l.length).width,m.fillText(""+l.length,this.minLeftMargin-u-8,this.alignmentGraphStartY+f),m.beginPath(),m.moveTo(this.minLeftMargin,this.alignmentGraphStartY+f),m.lineTo(this.minLeftMargin-5,this.alignmentGraphStartY+f),m.stroke();var x=this.legendStartY+15,v=this.minLeftMargin+20,p=this.align_context.createLinearGradient(v,0,v+100,0),_=1/this.qualColor.length,d=0;for(d=0;d<this.qualColor.length;d+=1)p.addColorStop(_*d,this.qualColor[d]);m.fillStyle=p,m.fillRect(v,x,100,5),m.fillStyle="#000000",m.fillText("Alignment quality over "+g+"bp non-overlapping windows",v+100+10,x+this.yAxisFontSize),m.fillText("low",v,x+5+this.yAxisFontSize),u=this.align_context.measureText("high").width,m.fillText("high",v+100-u,x+5+this.yAxisFontSize),"orient"==t?l.sort(function(t,i){return t[4]===i[4]?"R"===t[4]?t[1]===i[1]?i[2]-t[2]:t[1]-i[1]:t[1]===i[1]?t[2]-i[2]:i[1]-t[1]:t[4]<i[4]?-1:t[4]>i[4]?1:0}):"end"==t?l.sort(function(t,i){return t[1]+t[2]==i[1]+i[2]?t[1]-i[1]:i[1]+i[2]-(t[1]+t[2])}):"div"==t?l.sort(function(t,i){return t[5]-i[5]}):l.sort(function(t,i){return t[1]===i[1]?i[2]-t[2]:t[1]-i[1]}),this.coverageGraph(this.coverageGraphStartY,this.coverageGraphHeight);var S=0,M=0;if("orient"!=t){var T=this.nice_bounds(1,this.json.length,10).steps;this.ruler(this.minLeftMargin,this.rulerStartY,h,n,1,this.json.length,T/10,T),this.currRulerY=0,S=a+n+r,M=1}for(d=0;d<l.length;d+=1){0===M&&"R"==l[d][4]&&(S+=a,this.currRulerY=S+d*(e+i),S=S+n+a+r,M=1);var y,Y,I,L=l[d][1]-1,w=l[d][3],G=0;for(I=0;I<l[d][2];I+=g){G==w.length&&(G-=1),y=w[G],Y=G==w.length-1?y:w[G+1];var b=this.minLeftMargin+(L+I)*o,H=this.align_context.createLinearGradient(b,0,b+c,0);H.addColorStop(0,this.qualColor[y-1]),H.addColorStop(1-s,this.qualColor[y-1]),H.addColorStop(1,this.qualColor[Y-1]),this.align_context.fillStyle=H;var j=(g+.5)*o;I+g>=l[d][2]&&(j=(l[d][2]-I)*o),this.align_context.fillRect(b,S+d*(e+i),j,i),this.minLeftMargin,G++}}},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=i:(t.AlignmentSummaryViewer=i,"function"==typeof define&&define.amd&&define("alignmentsummaryviewer",[],function(){return i}))}(this.window||"undefined"!=typeof global&&global||this);