/*! AlignmentSummaryViewer 08-01-2019 */
!function(a){"use strict";function b(a,b,c,d){this.json=c,this.align_canvas=a,this.parent_element=b,this.cursorImage=null,this.cursorImageStartX=0,this.cursorImageStartY=0,this.cursorImageWidth=0,this.cursorImageHeight=0,this.fontSize=10,this.minLeftMargin=55,this.minTopMargin=10,this.minBottomMargin=10,this.coverageGraphHeight=125,this.legendHeight=30,this.alignmentGlyphHeight=2,this.alignmentSpacing=0,this.rulerHeight=20,this.yAxisFontSize=10,this.rulerVerticalMargin=10,this.gradientWindowFrac=.1,this.coverageGraphStartY=this.minTopMargin,this.rulerStartY=this.coverageGraphStartY+this.coverageGraphHeight,this.alignmentGraphStartY=this.rulerStartY+this.rulerHeight,this.legendStartY=this.alignmentGraphStartY+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing);var e=this;this.align_canvas.addEventListener("mousemove",function(b){var c=a.getBoundingClientRect(),d={x:b.clientX-c.left,y:b.clientY-c.top};e.renderCrosshair(d.x,d.y)}),this.align_canvas.addEventListener("mouseout",function(a){null!==e.cursorImage&&e.align_context.putImageData(e.cursorImage,e.cursorImageStartX,e.cursorImageStartY)}),this.align_context=this.align_canvas.getContext("2d"),this.qualColor=["#ff6600","#ff9900","#ccff00","#66ff00","#00ff00","#99ff66","#00ffcc","#33ccff","#3399ff","#3333ff"],this.currRulerY=0,this.resize()}b.prototype.setData=function(a){this.json=a,this.align_context.clearRect(0,0,this.align_canvas.width,this.align_canvas.height),this.legendStartY=this.alignmentGraphStartY+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing),this.cursorImage=null,this.resize()},b.prototype.renderCrosshair=function(a,b){var c=this.align_context,d=this.json.length/(this.align_canvas.width-this.minLeftMargin),e=Math.floor(d*(a-this.minLeftMargin))+1,f=this.align_context.measureText(""+this.json.length).width,g=f+6;if(null!==this.cursorImage&&(c.putImageData(this.cursorImage,this.cursorImageStartX,this.cursorImageStartY),this.cursorImage=null),b>=this.alignmentGraphStartY&&b<this.legendStartY&&a>this.minLeftMargin){this.cursorImageStartX=a-2*g,this.cursorImageStartY=this.rulerStartY,this.cursorImageWidth=g+2*g,this.cursorImageHeight=this.legendStartY-this.rulerStartY,this.cursorImage=c.getImageData(this.cursorImageStartX,this.cursorImageStartY,this.cursorImageWidth,this.cursorImageHeight),c.lineWidth=1,c.beginPath(),c.moveTo(a,this.rulerStartY),c.lineTo(a,this.legendStartY-1),c.stroke(),b-g<this.rulerStartY&&(b=this.rulerStartY+g+2);var h=a;a+g/2>this.align_canvas.width&&(h=this.align_canvas.width-g/2),c.beginPath(),c.arc(h,b-g/2,g/2,0,2*Math.PI,!1),c.fillStyle="#ffffff",c.fill(),c.strokeStyle="#000000",c.stroke(),this.align_context.fillStyle="#000000",f=this.align_context.measureText(""+e).width,c.fillText(""+e,h-f/2,b-g/2+this.fontSize/2-1)}},b.prototype.resize=function(){this.align_canvas.width=this.parent_element.offsetWidth,this.align_canvas.height=this.minTopMargin+this.coverageGraphHeight+this.rulerHeight+this.json.alignments.length*(this.alignmentGlyphHeight+this.alignmentSpacing)+this.legendHeight+this.minBottomMargin,this.render("norm")},b.prototype.ruler=function(a,b,c,d,e,f,g,h){this.align_context.beginPath(),this.align_context.moveTo(a,b),this.align_context.lineTo(a+c,b),this.align_context.stroke();var i=10;if(this.align_context.font="normal "+i+"px Arial",!(d<2*i)){var j=c/(f-e+1),k=h*j,l=g*j,m=d-i-2,n=m/2;this.align_context.fillStyle="#000000";var o=0;if(k>0){var p=0;for(o=k;o<c;o+=k){p+=1,this.align_context.beginPath(),this.align_context.moveTo(a+o,b),this.align_context.lineTo(a+o,b+m),this.align_context.stroke();var q=this.align_context.measureText(""+p*h).width;this.align_context.fillText(""+p*h,a+o-q/2,b+m+i)}}if(l>0)for(o=l;o<c;o+=l)this.align_context.beginPath(),this.align_context.moveTo(a+o,b),this.align_context.lineTo(a+o,b+n),this.align_context.stroke()}},b.prototype.coverageGraph=function(a,b){var c=0,d=this.json.alignments,e=[],f=this.json.length/(this.align_canvas.width-this.minLeftMargin),g=(this.align_canvas.width-this.minLeftMargin)/this.json.length,h=this.align_context,i=a+this.yAxisFontSize/2,j=b-(i-a);if(h.beginPath(),h.moveTo(this.minLeftMargin-1,i),h.lineTo(this.minLeftMargin-1,a+b),h.stroke(),h.save(),h.translate(10,b/2),h.rotate(-Math.PI/2),h.textAlign="center",h.font="normal 10px Arial",h.fillText("Number of Matches",1,0),h.restore(),!(b<=i)){var k=0,l=0,m=0;for(l=0;l<d.length;l+=1){var n=d[l][1]-1,o=d[l][2];for(m=n;m<=n+o;m+=1)void 0!==e[m]?(e[m]=e[m]+1,e[m]>k&&(k=e[m])):(e[m]=1,e[m]>k&&(k=e[m]))}var p=this.align_context.measureText(""+k).width;h.fillText(""+k,this.minLeftMargin-p-8,a+this.yAxisFontSize),h.beginPath(),h.moveTo(this.minLeftMargin,i),h.lineTo(this.minLeftMargin-5,i),h.stroke();var q=0,r=this.nice_bounds(0,parseInt(k),5);for(q=r.steps;q<r.max;q+=r.steps){var s=a+b-this.scale(q,k,j);if(s<=10)break;var t=this.minLeftMargin;h.beginPath(),h.moveTo(t,s),h.lineTo(t-5,s),h.stroke(),p=this.align_context.measureText(""+q).width,h.fillText(q,t-p-8,s)}var u=j/k;this.align_context.fillStyle="#739025",this.align_context.strokeStyle="#000000";var v=this.minLeftMargin;if(f>=1){var w=this.align_canvas.width-this.minLeftMargin;this.align_context.beginPath(),this.align_context.moveTo(v,a+b-1);var x=0;for(l=0;l<w;l+=1){var y=0;for(m=0;m<Math.floor(f);m+=1)y+=e[Math.floor(x)+m];y+=e[Math.floor(x)+m+1]*(f%1);var z=y/f;x+=f,this.align_context.lineTo(v,a+b-z*u-1),v+=1}0===c?(this.align_context.lineTo(v,a+b-1),this.align_context.lineTo(0,a+b-1),this.align_context.fill()):this.align_context.stroke(),this.align_context.closePath()}else{for(this.align_context.beginPath(),this.align_context.moveTo(v,a+b-1),l=0;l<this.json.length;l+=1){var A=e[l];this.align_context.lineTo(v+g,a+b-A*u-1),v+=g}0===c?(this.align_context.lineTo(v,a+b-1),this.align_context.lineTo(0,a+b-1),this.align_context.fill()):this.align_context.stroke(),this.align_context.closePath()}}},b.prototype.nice_bounds=function(a,b,c){c=c||10;var d=b,e=b-a;0===e&&(a-=.5,b+=.5,e=b-a);var f=this.nice_number(e),g=this.nice_number(f/(c-1),!0);return a=Math.floor(a/g)*g,b=Math.ceil(b/g)*g,d-b<g/4&&(b=Math.floor(d/g)*g),{min:a,max:b,steps:g}},b.prototype.nice_number=function(a,b){b=b||!1;var c=Math.floor(Math.log(a)/Math.log(10)),d=a/Math.pow(10,c);return(b?d<1.5?1:d<3?2:d<7?5:10:d<=1?1:d<=2?2:d<=5?5:10)*Math.pow(10,c)},b.prototype.scale=function(a,b,c){return c*a/b},b.prototype.render=function(a){var b=this.alignmentGlyphHeight,c=this.alignmentSpacing,d=this.rulerHeight,e=this.rulerVerticalMargin,f=this.coverageGraphHeight,g=this.gradientWindowFrac,h=this.align_canvas.width-this.minLeftMargin,i=h/this.json.length,j=this.json.alignments,k=this.json.qualityBlockLen,l=k*i,m=j.length*(this.alignmentGlyphHeight+this.alignmentSpacing);this.cursorImage=null,this.align_context.clearRect(0,0,this.align_canvas.width,this.align_canvas.height);var n=this.align_context;n.beginPath(),n.moveTo(this.minLeftMargin-1,this.rulerStartY),n.lineTo(this.minLeftMargin-1,this.rulerStartY+this.rulerHeight+m),n.stroke(),n.save(),n.translate(10,this.alignmentGraphStartY+m/2),n.rotate(-Math.PI/2),n.textAlign="center",n.font="normal 10px Arial",n.fillText("Sequence",1,0),n.restore();var o=this.align_context.measureText("1").width;n.fillText("1",this.minLeftMargin-o-8,this.alignmentGraphStartY+this.yAxisFontSize/2),n.beginPath(),n.moveTo(this.minLeftMargin,this.alignmentGraphStartY+1),n.lineTo(this.minLeftMargin-5,this.alignmentGraphStartY+1),n.stroke(),o=this.align_context.measureText(""+j.length).width,n.fillText(""+j.length,this.minLeftMargin-o-8,this.alignmentGraphStartY+m),n.beginPath(),n.moveTo(this.minLeftMargin,this.alignmentGraphStartY+m),n.lineTo(this.minLeftMargin-5,this.alignmentGraphStartY+m),n.stroke();var p=this.legendStartY+15,q=this.minLeftMargin+20,r=100,s=5,t=this.align_context.createLinearGradient(q,0,q+r,0),u=1/this.qualColor.length,v=0;for(v=0;v<this.qualColor.length;v+=1)t.addColorStop(u*v,this.qualColor[v]);n.fillStyle=t,n.fillRect(q,p,r,s),n.fillStyle="#000000",n.fillText("Alignment quality over "+k+"bp non-overlapping windows",q+r+10,p+this.yAxisFontSize),n.fillText("low",q,p+s+this.yAxisFontSize),o=this.align_context.measureText("high").width,n.fillText("high",q+r-o,p+s+this.yAxisFontSize),"orient"==a?j.sort(function(a,b){return a[4]===b[4]?"R"===a[4]?a[1]===b[1]?b[2]-a[2]:a[1]-b[1]:a[1]===b[1]?a[2]-b[2]:b[1]-a[1]:a[4]<b[4]?-1:a[4]>b[4]?1:0}):"end"==a?j.sort(function(a,b){return a[1]+a[2]==b[1]+b[2]?a[1]-b[1]:b[1]+b[2]-(a[1]+a[2])}):"div"==a?j.sort(function(a,b){return a[5]-b[5]}):j.sort(function(a,b){return a[1]===b[1]?b[2]-a[2]:a[1]-b[1]}),this.coverageGraph(this.coverageGraphStartY,this.coverageGraphHeight);var w=0,x=0;if("orient"!=a){var y=this.nice_bounds(1,this.json.length,10).steps;this.ruler(this.minLeftMargin,this.rulerStartY,h,d,1,this.json.length,y/10,y),this.currRulerY=0,w=e+d+f,x=1}for(v=0;v<j.length;v+=1){0===x&&"R"==j[v][4]&&(w+=e,this.currRulerY=w+v*(c+b),w=w+d+e+f,x=1);var z,A,B,C=j[v][1]-1,D=j[v][3],E=0;for(B=0;B<j[v][2];B+=k){E==D.length&&(E-=1),z=D[E],A=E==D.length-1?z:D[E+1];var F=this.minLeftMargin+(C+B)*i,G=this.align_context.createLinearGradient(F,0,F+l,0);G.addColorStop(0,this.qualColor[z-1]),G.addColorStop(1-g,this.qualColor[z-1]),G.addColorStop(1,this.qualColor[A-1]),this.align_context.fillStyle=G;var H=(k+.5)*i;B+k>=j[v][2]&&(H=(j[v][2]-B)*i),this.align_context.fillRect(F,w+v*(c+b),H,b),this.minLeftMargin,E++}}},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=b:(a.AlignmentSummaryViewer=b,"function"==typeof define&&define.amd&&define("alignmentsummaryviewer",[],function(){return b}))}(this.window||"undefined"!=typeof global&&global||this);